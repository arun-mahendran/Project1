<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='tunex.png') }}">
<title>TuneX | Creator Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --bg: radial-gradient(circle at top left, #1b2735, #090a0f);
  --glass: rgba(255,255,255,0.08);
  --border: rgba(255,255,255,0.12);
  --text: #ffffff;
  --muted: rgba(255,255,255,0.65);
  --accent: #4fd1ff;
  --danger: #ff6b6b;
  --success: #10b981;
  --radius-lg: 22px;
  --radius-md: 14px;
  --blur: blur(16px);
  --transition: all 0.3s ease;
}

body.light {
  --bg: linear-gradient(135deg, #f5f7fa, #e4ecf3);
  --glass: rgba(255,255,255,0.9);
  --border: rgba(0,0,0,0.08);
  --text: #111;
  --muted: rgba(0,0,0,0.6);
  --success: #059669;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  min-height: 100vh;
  font-family: "Inter", system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* OVERLAY FOR BLUR */
#overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(6px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 90;
}
#overlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* HEADER */
header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  padding: 18px 36px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: var(--blur);
  background: rgba(0,0,0,0.35);
  border-bottom: 1px solid var(--border);
  z-index: 100;
}

.logo { font-size: 22px; font-weight: 700; }

.avatar-wrapper { position: relative; z-index: 110; }

.avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #89f7fe);
  color: #000;
  display: grid;
  place-items: center;
  font-weight: bold;
  cursor: pointer;
}

.menu {
  position: absolute;
  right: 0;
  top: 56px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  min-width: 180px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-10px);
  transition: var(--transition);
  z-index: 120;
}

.menu.active {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.menu button, .menu a {
  width: 100%;
  padding: 12px 16px;
  background: none;
  border: none;
  text-align: left;
  color: var(--text);
  cursor: pointer;
  text-decoration: none;
}

.container {
  max-width: 1200px;
  margin: 140px auto 80px;
  padding: 0 24px 80px;
}

.grid {
  display: grid;
  grid-template-columns: 420px 1fr;
  gap: 30px;
  align-items: start;
}

@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
}

/* UPLOAD CARD */
.card-upload {
  background: var(--glass);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  padding: 28px;
  backdrop-filter: var(--blur);
  height: fit-content;
}

/* MANAGE SONGS CARD */
.card-manage {
  background: var(--glass);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  padding: 28px;
  backdrop-filter: var(--blur);
  display: flex;
  flex-direction: column;
  height: 80vh;
  max-height: 800px;
}

.card-manage h3 {
  margin-bottom: 24px;
}

.manage-content {
  flex: 1;
  overflow-y: auto;
  margin-top: 16px;
  padding-right: 8px;
}

.manage-content::-webkit-scrollbar {
  width: 6px;
}
.manage-content::-webkit-scrollbar-track {
  background: transparent;
}
.manage-content::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
}

#songSearch {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.18);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 15px;
}

#songSearch::placeholder {
  color: var(--muted);
}

.song-row {
  display: grid;
  grid-template-columns: 1fr 280px auto;
  gap: 20px;
  align-items: center;
  padding: 16px 0;
  border-bottom: 1px solid var(--border);
}

.song-info {
  display: flex;
  flex-direction: column;
}

.song-title-input {
  font-size: 16px;
  font-weight: 500;
  background: transparent;
  border: none;
  color: var(--text);
  width: 100%;
}

.song-player audio {
  width: 100%;
  height: 36px;
}

.song-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-self: end;
}

.song-actions button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  color: var(--text);
}

.delete-btn { color: var(--danger); }
.save-btn { color: var(--accent); }

.genre { display: none; }

label { font-size: 13px; color: var(--muted); }

input, select {
  width: 100%;
  padding: 14px;
  margin-top: 6px;
  margin-bottom: 18px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.18);
  color: var(--text);
  border: none;
}

input::placeholder {
  color: var(--muted);
  opacity: 1;
}

select {
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23ffffff' d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
}

body:not(.light) select {
  background-color: rgba(255,255,255,0.12);
}

body:not(.light) select option {
  background-color: #0f172a;
  color: #ffffff;
}

body.light select option {
  background-color: #ffffff;
  color: #000000;
}

button.primary {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius-md);
  border: none;
  background: linear-gradient(135deg, var(--accent), #89f7fe);
  font-weight: 600;
  cursor: pointer;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 130;
}

.modal.active { display: flex; }

.modal-box {
  background: var(--glass);
  border: 1px solid var(--border);
  backdrop-filter: var(--blur);
  border-radius: var(--radius-lg);
  padding: 26px;
  width: 320px;
  text-align: center;
}

.modal-box p {
  margin: 14px 0 22px;
  color: var(--muted);
}

.modal-actions {
  display: flex;
  gap: 12px;
}

.modal-actions button {
  flex: 1;
  padding: 12px;
  border-radius: var(--radius-md);
  border: none;
  cursor: pointer;
}

.cancel-btn {
  background: rgba(255,255,255,0.15);
  color: var(--text);
}

.confirm-btn {
  background: var(--danger);
  color: #fff;
}

h1 {
  font-size: 26px;
  margin-bottom: 6px;
  font-weight: 600;
}

h1 + p {
  margin-bottom: 40px;
  font-size: 15px;
}

/* ANALYTICS */
.analytics-full {
  background: var(--glass);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  padding: 28px;
  backdrop-filter: var(--blur);
  margin-top: 40px;
}

.analytics-full h4 {
  margin: 0 0 20px 0;
  color: var(--success);
  font-size: 20px;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.stat-card {
  text-align: center;
  padding: 20px;
  border-radius: 16px;
  background: rgba(255,255,255,0.08);
}

.stat-number {
  font-size: 32px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 8px;
}

.stat-label {
  font-size: 14px;
  color: var(--muted);
}

.top-song {
  font-size: 16px;
  color: var(--success);
  font-weight: 600;
  margin-top: 12px;
  opacity: 0.9;
}

body.light .analytics-full {
  background: rgba(255,255,255,0.95);
}
</style>
</head>

<body>

<div id="overlay" onclick="closeMenu()"></div>

<header>
  <div class="logo">TuneX</div>
  <div class="avatar-wrapper">
    <div class="avatar" onclick="toggleMenu()">
      {{ username[0]|upper }}
    </div>
    <div class="menu" id="menu">
      <button onclick="toggleTheme()">Toggle Theme</button>
      <a href="/logout">Logout</a>
    </div>
  </div>
</header>

<div class="container">

  <h1>Welcome, {{ username }} üëã</h1>
  <p style="color:var(--muted);">
    Upload, manage and control your music
  </p>

  <div class="grid">

    <div class="card-upload">
      <h3>Upload Track</h3><br>
      <form action="/creator/upload" method="POST" enctype="multipart/form-data">
        <label>Song Title</label>
        <input type="text" name="title" placeholder="Title" required>

        <label>Genre</label>
        <select name="genre_id" required>
          {% for genre in genres %}
          <option value="{{ genre.genre_id }}">{{ genre.genre_name }}</option>
          {% endfor %}
        </select>

        <label>Audio File</label>
        <input type="file" name="song" required>

        <button class="primary">Upload Song</button>
      </form>
    </div>

    <div class="card-manage">
      <h3>Manage Songs</h3>

      <input type="text" id="songSearch" placeholder="Search by title or genre...">

      <div class="manage-content">
        {% for song in songs %}
        <div class="song-row" 
             data-title="{{ song.title | lower }}"
             data-genre="{{ song.genre.genre_name | lower }}">

          <div class="song-info">
            <form action="/creator/edit/{{ song.song_id }}" method="POST" style="width:100%;">
              <input class="song-title-input" name="title" value="{{ song.title }}" readonly>
            </form>
            <span class="genre">{{ song.genre.genre_name }}</span>
          </div>

          <div class="song-player">
            <audio controls data-song-id="{{ song.song_id }}">
              <source src="/{{ song.file_path }}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
          </div>

          <div class="song-actions">
            <button type="button" onclick="enableEdit(this)">‚úèÔ∏è</button>
            <button type="submit" class="save-btn" style="display:none"
              onclick="this.closest('.song-row').querySelector('form').submit()">‚úî</button>
            <button class="delete-btn" onclick="openDeleteModal(this)">üóë</button>
          </div>

        </div>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- ANALYTICS -->
  <div class="analytics-full">
    <h4>üìä Your Analytics</h4>
    <div class="analytics-grid">
      <div class="stat-card">
        <div class="stat-number">{{ total_songs }}</div>
        <div class="stat-label">Total Songs</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ total_plays }}</div>
        <div class="stat-label">Total Listens</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ top_song.play_count if top_song else 0 }}</div>
        <div class="stat-label">Most Played</div>
        {% if top_song %}
        <div class="top-song">
          {{ top_song.title }} <span style="opacity:0.8; font-size:14px;">({{ top_song.play_count }} plays)</span>
        </div>
        {% else %}
        <div class="top-song" style="opacity:0.6;">No plays yet</div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<div class="modal" id="deleteModal">
  <div class="modal-box">
    <h3>Delete Song?</h3>
    <p>This action cannot be undone.</p>
    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
      <button class="confirm-btn" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<form id="deleteForm" method="POST" style="display:none;"></form>

<script>
let deleteAction = "";

function toggleMenu() {
  const menu = document.getElementById("menu");
  const overlay = document.getElementById("overlay");
  menu.classList.toggle("active");
  overlay.classList.toggle("active");
}

function closeMenu() {
  document.getElementById("menu").classList.remove("active");
  document.getElementById("overlay").classList.remove("active");
}

function toggleTheme() {
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
}

(function () {
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
  }
})();

function enableEdit(btn) {
  const row = btn.closest(".song-row");
  const input = row.querySelector(".song-title-input");
  const saveBtn = row.querySelector(".save-btn");
  
  input.removeAttribute("readonly");
  input.focus();
  const length = input.value.length;
  input.setSelectionRange(length, length);
  saveBtn.style.display = "inline";
}

function openDeleteModal(btn) {
  const songRow = btn.closest(".song-row");
  const formAction = songRow.querySelector("form").action;
  deleteAction = formAction.replace("/edit/", "/delete/");
  document.getElementById("deleteModal").classList.add("active");
}

function closeDeleteModal() {
  document.getElementById("deleteModal").classList.remove("active");
}

function confirmDelete() {
  const form = document.getElementById("deleteForm");
  form.action = deleteAction;
  form.submit();
}

/* SEARCH */
document.getElementById("songSearch").addEventListener("input", () => {
  const query = document.getElementById("songSearch").value.trim().toLowerCase();
  const rows = document.querySelectorAll(".song-row");

  rows.forEach(row => {
    const title = row.dataset.title;
    const genre = row.dataset.genre || "";
    if (query === "" || title.includes(query) || genre.includes(query)) {
      row.style.display = "grid";
    } else {
      row.style.display = "none";
    }
  });
});

/* IMPROVED PLAY TRACKING: Count only when ‚â•30% of song is listened */
const audios = document.querySelectorAll("audio");

audios.forEach(audio => {
  let hasCountedPlay = false; // Prevent counting multiple times in one session

  const checkProgress = () => {
    if (hasCountedPlay) return;

    const duration = audio.duration;
    if (isNaN(duration) || duration === 0) return;

    if (audio.currentTime >= duration * 0.3) { // 30% threshold
      hasCountedPlay = true;

      const songId = audio.dataset.songId;
      if (songId) {
        fetch(`/api/song/${songId}/play`, { method: 'POST' })
          .catch(err => console.log("Play count update failed:", err));
      }
    }
  };

  // Monitor progress while playing
  audio.addEventListener("timeupdate", checkProgress);

  // Reset flag when user starts playing again
  audio.addEventListener("play", () => {
    hasCountedPlay = false;

    // Pause all other audios
    audios.forEach(other => {
      if (other !== audio) {
        other.pause();
        other.currentTime = 0;
      }
    });
  });
});
</script>

</body>
</html>